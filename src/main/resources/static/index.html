<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>学生选课管理系统-谢玮杰</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        :root {
            --dark-blue: #111827;
            --darker-blue: #0c1220;
            --accent-blue: #22d3ee;
            --text-light: #e2e8f0;
            --text-secondary: #94a3b8;
            --card-bg: #1e293b;
            --border-color: #334155;
            --hover-bg: #334155;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--dark-blue);
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .logo-container {
            text-align: center;
            padding: 2rem 0;
        }

        .logo-circle {
            width: 80px;
            height: 80px;
            background-color: rgba(34, 211, 238, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
        }

        .logo-icon {
            color: var(--accent-blue);
            font-size: 2.5rem;
        }

        .system-title {
            color: var(--accent-blue);
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .system-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .main-container {
            /* max-width: 1200px; */
            /* margin: 0 auto; */
            padding: 0 1rem;
            flex: 1;
        }

        .nav-tabs {
            border: none;
            background-color: var(--darker-blue);
            border-radius: 0.5rem;
            padding: 0.25rem;
            margin-bottom: 1.5rem;
        }

        .nav-tabs .nav-link {
            color: var(--text-secondary);
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            margin: 0.25rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-tabs .nav-link:hover {
            color: var(--text-light);
            background-color: rgba(255, 255, 255, 0.05);
        }

        .nav-tabs .nav-link.active {
            color: var(--text-light);
            background-color: #3b82f6;
            font-weight: 500;
        }

        .content-card {
            background-color: var(--darker-blue);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .search-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .search-input {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-input i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .search-input input {
            width: 100%;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--text-light);
            padding: 0.75rem 1rem 0.75rem 2.5rem;
        }

        .search-input input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.2);
        }

        .search-input input::placeholder {
            color: var(--text-secondary);
        }

        .btn-primary {
            background-color: var(--accent-blue);
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background-color: #0ea5e9;
            transform: translateY(-1px);
        }

        .table {
            color: var(--text-light);
            margin-bottom: 0;
        }

        .table th {
            color: var(--text-secondary);
            font-weight: 500;
            border-top: none;
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0.75rem;
        }

        .table td {
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0.75rem;
            vertical-align: middle;
        }

        .table tbody tr {
            transition: background-color 0.2s ease;
        }

        .table tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-light);
            transition: all 0.2s ease;
        }

        .btn-edit {
            color: var(--warning-color);
            border-color: var(--warning-color);
        }

        .btn-edit:hover {
            background-color: rgba(245, 158, 11, 0.1);
        }

        .btn-delete {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .btn-delete:hover {
            background-color: rgba(239, 68, 68, 0.1);
        }

        .btn-select {
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .btn-select:hover {
            background-color: rgba(16, 185, 129, 0.1);
        }

        .btn-view {
            color: var(--info-color);
            border-color: var(--info-color);
        }

        .btn-view:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }

        .footer {
            text-align: center;
            padding: 2rem 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Modal Styling */
        .modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            color: var(--text-light);
        }

        .modal-header {
            border-bottom: 1px solid var(--border-color);
            padding: 1.25rem 1.5rem;
        }

        .modal-title {
            color: var(--accent-blue);
            font-weight: 600;
        }

        .modal-header .btn-close {
            color: var(--text-light);
            background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23ffffff'%3e%3cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3e%3c/svg%3e") center/1em auto no-repeat;
            opacity: 0.75;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            border-top: 1px solid var(--border-color);
            padding: 1.25rem 1.5rem;
        }

        .form-label {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-control {
            background-color: var(--dark-blue);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--text-light);
            padding: 0.75rem 1rem;
        }

        .form-control:focus {
            background-color: var(--dark-blue);
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.2);
            color: var(--text-light);
        }

        .form-control::placeholder {
            color: var(--text-secondary);
        }

        .form-control:disabled, .form-control[readonly] {
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
        }

        .btn-secondary {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-light);
        }

        .btn-secondary:hover {
            background-color: var(--hover-bg);
            border-color: var(--border-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
            border: none;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-success {
            background-color: var(--success-color);
            border: none;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .btn-warning {
            background-color: var(--warning-color);
            border: none;
            color: #fff;
        }

        .btn-warning:hover {
            background-color: #d97706;
            color: #fff;
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .tab-pane {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .search-container {
                flex-direction: column;
                gap: 1rem;
            }

            .search-input {
                max-width: 100%;
            }

            .action-buttons {
                flex-wrap: wrap;
            }

            .system-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
<!-- Logo and Title -->
<div class="logo-container">
    <div class="logo-circle">
        <i class="bi bi-mortarboard-fill logo-icon"></i>
    </div>
    <h1 class="system-title">学生选课管理系统</h1>
    <p class="system-subtitle">现代化、高效的学生课程管理平台</p>
</div>

<div class="main-container">
    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="student-tab" data-bs-toggle="tab" data-bs-target="#student" type="button" role="tab" aria-controls="student" aria-selected="true">
                <i class="bi bi-people-fill"></i> 学生管理
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="course-tab" data-bs-toggle="tab" data-bs-target="#course" type="button" role="tab" aria-controls="course" aria-selected="false">
                <i class="bi bi-book-fill"></i> 课程管理
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="sc-tab" data-bs-toggle="tab" data-bs-target="#sc" type="button" role="tab" aria-controls="sc" aria-selected="false">
                <i class="bi bi-clipboard-check-fill"></i> 选课管理
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="teacher-tab" data-bs-toggle="tab" data-bs-target="#teacher" type="button" role="tab" aria-controls="teacher" aria-selected="false">
                <i class="bi bi-person-workspace"></i> 教师管理
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="myTabContent">
        <!-- 学生管理 -->
        <div class="tab-pane fade show active" id="student" role="tabpanel" aria-labelledby="student-tab">
            <div class="content-card">
                <div class="search-container">
                    <div class="search-input">
                        <i class="bi bi-search"></i>
                        <input type="text" placeholder="搜索学生 (姓名, 学号, 院系...)" id="studentSearch">
                </div>
                    <button class="btn btn-primary" onclick="showAddStudentModal()">
                        <i class="bi bi-plus-lg"></i> 添加学生
                    </button>
            </div>

            <div class="table-responsive">
                    <table class="table">
                    <thead>
                    <tr>
                        <th>学号</th>
                        <th>姓名</th>
                        <th>性别</th>
                        <th>年龄</th>
                        <th>院系</th>
                            <th>平均成绩</th>
                            <th class="text-end">操作</th>
                    </tr>
                    </thead>
                    <tbody id="studentTableBody"></tbody>
                </table>
                </div>
            </div>
        </div>

        <!-- 课程管理 -->
        <div class="tab-pane fade" id="course" role="tabpanel" aria-labelledby="course-tab">
            <div class="content-card">
                <div class="search-container">
                    <div class="search-input">
                        <i class="bi bi-search"></i>
                        <input type="text" placeholder="搜索课程 (课程名, 课程号...)" id="courseSearch">
                </div>
                    <button class="btn btn-primary" onclick="showAddCourseModal()">
                        <i class="bi bi-plus-lg"></i> 添加课程
                    </button>
            </div>

            <div class="table-responsive">
                    <table class="table">
                    <thead>
                    <tr>
                        <th>课程号</th>
                        <th>课程名</th>
                        <th>先修课程</th>
                        <th>学分</th>
                            <th>选课人数</th>
                            <th>平均成绩</th>
                            <th class="text-end">操作</th>
                    </tr>
                    </thead>
                    <tbody id="courseTableBody"></tbody>
                </table>
                </div>
            </div>
        </div>

        <!-- 选课管理 -->
        <div class="tab-pane fade" id="sc" role="tabpanel" aria-labelledby="sc-tab">
            <div class="content-card">
                <div class="search-container">
                    <div class="search-input">
                        <i class="bi bi-search"></i>
                        <input type="text" placeholder="搜索选课记录 (学号, 课程号...)" id="scSearch">
                </div>
                    <button class="btn btn-primary" onclick="showAddSCModal()">
                        <i class="bi bi-plus-lg"></i> 添加选课
                    </button>
            </div>

            <div class="table-responsive">
                    <table class="table">
                    <thead>
                    <tr>
                        <th>学号</th>
                        <th>课程号</th>
                        <th>成绩</th>
                            <th class="text-end">操作</th>
                    </tr>
                    </thead>
                    <tbody id="scTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
        
        <!-- 教师管理 -->
        <div class="tab-pane fade" id="teacher" role="tabpanel" aria-labelledby="teacher-tab">
            <div class="content-card">
                <div class="search-container">
                    <div class="search-input">
                        <i class="bi bi-search"></i>
                        <input type="text" placeholder="搜索教师 (姓名, 课程...)" id="teacherSearch">
                    </div>
                    <button class="btn btn-primary" onclick="showAddTeacherModal()">
                        <i class="bi bi-plus-lg"></i> 添加教师
                    </button>
</div>

                <div class="table-responsive">
                    <table class="table">
                        <thead>
                        <tr>
                            <th>教师姓名</th>
                            <th>讲授课程</th>
                            <th class="text-end">操作</th>
                        </tr>
                        </thead>
                        <tbody id="teacherTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    <p>© 2025 学生选课管理系统. All rights reserved.</p>
</footer>

<!-- 添加学生模态框 -->
<div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addStudentModalLabel">添加学生</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addStudentForm">
                    <div class="mb-3">
                        <label for="snoAdd" class="form-label">学号</label>
                        <input type="text" class="form-control" id="snoAdd" name="sno" required>
                    </div>
                    <div class="mb-3">
                        <label for="snameAdd" class="form-label">姓名</label>
                        <input type="text" class="form-control" id="snameAdd" name="sname" required>
                    </div>
                    <div class="mb-3">
                        <label for="sgenderAdd" class="form-label">性别</label>
                        <input type="text" class="form-control" id="sgenderAdd" name="sgender" required>
                    </div>
                    <div class="mb-3">
                        <label for="sageAdd" class="form-label">年龄</label>
                        <input type="number" class="form-control" id="sageAdd" name="sage" required>
                    </div>
                    <div class="mb-3">
                        <label for="sdeptAdd" class="form-label">院系</label>
                        <input type="text" class="form-control" id="sdeptAdd" name="sdept" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="addStudent()">确定</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加课程模态框 -->
<div class="modal fade" id="addCourseModal" tabindex="-1" aria-labelledby="addCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCourseModalLabel">添加课程</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addCourseForm">
                    <div class="mb-3">
                        <label for="cnoAdd" class="form-label">课程号</label>
                        <input type="text" class="form-control" id="cnoAdd" name="cno" required>
                    </div>
                    <div class="mb-3">
                        <label for="cnameAdd" class="form-label">课程名</label>
                        <input type="text" class="form-control" id="cnameAdd" name="cname" required>
                    </div>
                    <div class="mb-3">
                        <label for="cpnoAdd" class="form-label">先修课程</label>
                        <input type="text" class="form-control" id="cpnoAdd" name="cpno">
                    </div>
                    <div class="mb-3">
                        <label for="ccreditAdd" class="form-label">学分</label>
                        <input type="number" class="form-control" id="ccreditAdd" name="ccredit" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="addCourse()">确定</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加选课模态框 -->
<div class="modal fade" id="addSCModal" tabindex="-1" aria-labelledby="addSCModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSCModalLabel">添加选课</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addSCForm">
                    <div class="mb-3">
                        <label for="snoScAdd" class="form-label">学号</label>
                        <input type="text" class="form-control" id="snoScAdd" name="sno" required>
                    </div>
                    <div class="mb-3">
                        <label for="cnoScAdd" class="form-label">课程号</label>
                        <input type="text" class="form-control" id="cnoScAdd" name="cno" required>
                    </div>
                    <div class="mb-3">
                        <label for="gradeScAdd" class="form-label">成绩</label>
                        <input type="number" class="form-control" id="gradeScAdd" name="grade" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="addSC()">确定</button>
            </div>
        </div>
    </div>
</div>

<!-- 选课模态框 -->
<div class="modal fade" id="selectCourseModal" tabindex="-1" aria-labelledby="selectCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectCourseModalLabel">学生选课</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="studentSnoForSelectCourse">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>课程号</th>
                                <th>课程名</th>
                                <th>先修课程</th>
                                <th>学分</th>
                            <th class="text-end">操作</th>
                            </tr>
                        </thead>
                        <tbody id="availableCoursesTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 退课模态框 -->
<div class="modal fade" id="dropCourseModal" tabindex="-1" aria-labelledby="dropCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dropCourseModalLabel">学生退课</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="studentSnoForDropCourse">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>课程号</th>
                                <th>课程名</th>
                                <th>成绩</th>
                            <th class="text-end">操作</th>
                            </tr>
                        </thead>
                        <tbody id="studentCoursesTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑学生信息模态框 -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editStudentModalLabel">编辑学生信息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editStudentForm">
                    <div class="mb-3">
                        <label class="form-label">学号</label>
                        <input type="text" class="form-control" name="sno" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">姓名</label>
                        <input type="text" class="form-control" name="sname" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">性别</label>
                        <input type="text" class="form-control" name="sgender" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">年龄</label>
                        <input type="number" class="form-control" name="sage" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">院系</label>
                        <input type="text" class="form-control" name="sdept" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateStudent()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑课程信息模态框 -->
<div class="modal fade" id="editCourseModal" tabindex="-1" aria-labelledby="editCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCourseModalLabel">编辑课程信息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCourseForm">
                    <div class="mb-3">
                        <label class="form-label">课程号</label>
                        <input type="text" class="form-control" name="cno" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">课程名</label>
                        <input type="text" class="form-control" name="cname" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">先修课程</label>
                        <input type="text" class="form-control" name="cpno" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">学分</label>
                        <input type="number" class="form-control" name="ccredit" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateCourse()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑选课成绩模态框 -->
<div class="modal fade" id="editSCModal" tabindex="-1" aria-labelledby="editSCModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSCModalLabel">编辑选课成绩</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editSCForm">
                    <div class="mb-3">
                        <label class="form-label">学号</label>
                        <input type="text" class="form-control" name="sno" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">课程号</label>
                        <input type="text" class="form-control" name="cno" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">成绩</label>
                        <input type="number" class="form-control" name="grade" required min="0" max="100">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateSC()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除学生确认模态框 -->
<div class="modal fade" id="deleteStudentConfirmModal" tabindex="-1" aria-labelledby="deleteStudentConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteStudentConfirmModalLabel">确认删除学生</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>该学生存在以下选课记录，这些记录将被一并删除，是否确认？</p>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>课程号</th>
                                <th>课程名称</th>
                                <th>成绩</th>
                            </tr>
                        </thead>
                        <tbody id="studentCoursesToDeleteTableBody"></tbody>
                    </table>
                </div>
                <input type="hidden" id="studentSnoToDelete">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="executeDeleteStudent()">确认删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除课程确认模态框 -->
<div class="modal fade" id="deleteCourseConfirmModal" tabindex="-1" aria-labelledby="deleteCourseConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteCourseConfirmModalLabel">确认删除课程</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>该课程存在以下选课记录，这些记录将被一并删除，是否确认？</p>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                        <tr>
                            <th>学号</th>
                            <th>姓名</th>
                            <th>成绩</th>
                        </tr>
                        </thead>
                        <tbody id="courseStudentsToDeleteTableBody"></tbody>
                    </table>
                </div>
                <input type="hidden" id="courseCnoToDelete">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="executeDeleteCourse()">确认删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 查看课程选课学生模态框 -->
<div class="modal fade" id="courseStudentsModal" tabindex="-1" aria-labelledby="courseStudentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="courseStudentsModalLabel">课程选课学生成绩</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                        <tr>
                            <th>学号</th>
                            <th>姓名</th>
                            <th>成绩</th>
                        </tr>
                        </thead>
                        <tbody id="courseStudentsTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加教师模态框 -->
<div class="modal fade" id="addTeacherModal" tabindex="-1" aria-labelledby="addTeacherModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTeacherModalLabel">添加教师</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTeacherForm">
                    <div class="mb-3">
                        <label for="tNameAdd" class="form-label">教师姓名</label>
                        <input type="text" class="form-control" id="tNameAdd" name="tName" required>
                    </div>
                    <div class="mb-3">
                        <label for="tCourseAdd" class="form-label">讲授课程</label>
                        <select class="form-control" id="tCourseAdd" name="tCourse" required>
                            <option value="" disabled selected>请选择课程</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="addTeacher()">确定</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑教师模态框 -->
<div class="modal fade" id="editTeacherModal" tabindex="-1" aria-labelledby="editTeacherModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTeacherModalLabel">编辑教师</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTeacherForm">
                    <div class="mb-3">
                        <label for="tNameEdit" class="form-label">教师姓名</label>
                        <input type="text" class="form-control" id="tNameEdit" name="tName" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="tCourseEdit" class="form-label">讲授课程</label>
                        <select class="form-control" id="tCourseEdit" name="tCourse" required>
                            <option value="" disabled>请选择课程</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateTeacher()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 教师的学生和成绩模态框 -->
<div class="modal fade" id="teacherStudentsModal" tabindex="-1" aria-labelledby="teacherStudentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teacherStudentsModalLabel">选修课程的学生成绩</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="course-info mb-3">
                    <strong>教师:</strong> <span id="modalTeacherName"></span>
                    <strong class="ms-3">课程:</strong> <span id="modalCourseName"></span>
                </div>
                <div class="table-container">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>学号</th>
                                <th>学生姓名</th>
                                <th>成绩</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="teacherStudentsTableBody">
                            <!-- 学生成绩数据将在这里动态添加 -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑成绩模态框 -->
<div class="modal fade" id="editGradeModal" tabindex="-1" aria-labelledby="editGradeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editGradeModalLabel">修改成绩</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editGradeForm">
                    <div class="mb-3">
                        <label for="studentNameGrade" class="form-label">学生姓名</label>
                        <input type="text" class="form-control" id="studentNameGrade" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="studentNoGrade" class="form-label">学号</label>
                        <input type="text" class="form-control" id="studentNoGrade" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="courseNameGrade" class="form-label">课程</label>
                        <input type="text" class="form-control" id="courseNameGrade" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="gradeInput" class="form-label">成绩</label>
                        <input type="number" class="form-control" id="gradeInput" min="0" max="100" required>
                    </div>
                    <input type="hidden" id="snoGrade">
                    <input type="hidden" id="cnoGrade">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateGrade()">保存</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
<script>
    const API_BASE_URL = 'http://localhost:8080/api';

    let allStudents = []; // 存储所有学生信息

    // 页面加载完成后执行
    $(document).ready(function() {
        // 初始化搜索功能
        initSearch();

        // 加载数据
        loadStudents();
        loadCourses();
        loadSCs();
        loadTeachers();
    });

    // 初始化搜索功能
    function initSearch() {
        $('#studentSearch').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            filterTable('#studentTableBody tr', searchTerm);
        });

        $('#courseSearch').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            filterTable('#courseTableBody tr', searchTerm);
        });

        $('#scSearch').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            filterTable('#scTableBody tr', searchTerm);
        });
        
        $('#teacherSearch').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            filterTable('#teacherTableBody tr', searchTerm);
        });
    }

    // 表格过滤函数
    function filterTable(selector, term) {
        $(selector).each(function() {
            const text = $(this).text().toLowerCase();
            $(this).toggle(text.indexOf(term) > -1);
        });
    }

    // 计算学生的加权平均成绩
    function calculateStudentAvgGrade(studentSno) {
        return new Promise((resolve, reject) => {
            // 获取学生的选课记录
            $.get(`${API_BASE_URL}/sc/student/${studentSno}`, function(studentCourses) {
                // 过滤掉未修读完毕的课程（成绩为0）
                const completedCourses = studentCourses.filter(sc => sc.grade > 0);
                
                // 如果没有完成的课程，返回null
                if (completedCourses.length === 0) {
                    resolve(null);
                    return;
                }
                
                // 获取所有课程信息，用于获取学分
                $.get(`${API_BASE_URL}/course`, function(allCourses) {
                    // 创建课程ID到学分的映射
                    const courseCreditsMap = {};
                    allCourses.forEach(course => {
                        courseCreditsMap[course.cno] = course.ccredit;
                    });
                    
                    // 计算总学分
                    let totalCredits = 0;
                    completedCourses.forEach(sc => {
                        totalCredits += courseCreditsMap[sc.cno] || 0;
                    });
                    
                    // 如果总学分为0，返回null
                    if (totalCredits === 0) {
                        resolve(null);
                        return;
                    }
                    
                    // 计算加权总分
                    let weightedTotalGrade = 0;
                    completedCourses.forEach(sc => {
                        const credit = courseCreditsMap[sc.cno] || 0;
                        const weight = credit / totalCredits;
                        weightedTotalGrade += sc.grade * weight;
                    });
                    
                    // 保留两位小数
                    const avgGrade = parseFloat(weightedTotalGrade.toFixed(2));
                    resolve(avgGrade);
                }).fail(function(error) {
                    console.error('获取课程信息失败:', error);
                    resolve(null);
                });
            }).fail(function(error) {
                console.error('获取学生选课信息失败:', error);
                resolve(null);
            });
        });
    }

    // 计算课程的平均成绩
    function calculateCourseAvgGrade(courseCno) {
        return new Promise((resolve, reject) => {
            // 获取选修该课程的记录
            $.get(`${API_BASE_URL}/sc/course/${courseCno}`, function(courseRecords) {
                // 过滤掉未修读完毕的课程（成绩为0）
                const completedRecords = courseRecords.filter(sc => sc.grade > 0);
                
                // 如果没有完成的记录，返回null
                if (completedRecords.length === 0) {
                    resolve(null);
                    return;
                }
                
                // 计算平均成绩
                let totalGrade = 0;
                completedRecords.forEach(sc => {
                    totalGrade += sc.grade;
                });
                
                // 保留两位小数
                const avgGrade = parseFloat((totalGrade / completedRecords.length).toFixed(2));
                resolve(avgGrade);
            }).fail(function(error) {
                console.error('获取课程选课记录失败:', error);
                resolve(null);
            });
        });
    }

    // 加载学生数据并计算平均成绩
    function loadStudents() {
        $.get(`${API_BASE_URL}/student`, function(data) {
            const tbody = $('#studentTableBody');
            tbody.empty();
            allStudents = data; // 存储学生数据供后续使用
            
            // 创建一个Promise数组来处理所有学生的平均成绩计算
            const avgGradePromises = data.map(student => {
                return calculateStudentAvgGrade(student.sno).then(avgGrade => {
                    return { ...student, avgGrade };
                });
            });
            
            // 等待所有计算完成
            Promise.all(avgGradePromises).then(studentsWithAvgGrade => {
                // 按平均成绩降序排序（null值排在最后）
                studentsWithAvgGrade.sort((a, b) => {
                    if (a.avgGrade === null && b.avgGrade === null) return 0;
                    if (a.avgGrade === null) return 1;
                    if (b.avgGrade === null) return -1;
                    return b.avgGrade - a.avgGrade;
                });
                
                // 渲染表格
                studentsWithAvgGrade.forEach(student => {
                tbody.append(`
                        <tr class="fade-in">
                            <td>${student.sno}</td>
                            <td>${student.sname}</td>
                            <td>${student.sgender}</td>
                            <td>${student.sage}</td>
                            <td>${student.sdept}</td>
                            <td>${student.avgGrade !== null ? student.avgGrade : 'N/A'}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-icon btn-edit" onclick="showEditStudentModal('${student.sno}')" title="编辑">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                    <button class="btn-icon btn-delete" onclick="deleteStudent('${student.sno}')" title="删除">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                    <button class="btn-icon btn-select" onclick="showSelectCourseModal('${student.sno}')" title="选课">
                                        <i class="bi bi-plus-circle-fill"></i>
                                    </button>
                                    <button class="btn-icon btn-view" onclick="showDropCourseModal('${student.sno}')" title="退课">
                                        <i class="bi bi-dash-circle-fill"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `);
                });
            });
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error('加载学生数据失败:', textStatus, errorThrown);
            alert('加载学生数据失败，请检查后端服务是否正常运行');
        });
    }

    // 加载课程数据并计算平均成绩
    function loadCourses() {
        $.get(`${API_BASE_URL}/course/with-student-count`, function(data) {
            const tbody = $('#courseTableBody');
            tbody.empty();
            
            // 创建一个Promise数组来处理所有课程的平均成绩计算
            const avgGradePromises = data.map(course => {
                return calculateCourseAvgGrade(course.cno).then(avgGrade => {
                    return { ...course, avgGrade };
                });
            });
            
            // 等待所有计算完成
            Promise.all(avgGradePromises).then(coursesWithAvgGrade => {
                // 渲染表格
                coursesWithAvgGrade.forEach(course => {
                tbody.append(`
                        <tr class="fade-in">
                            <td>${course.cno}</td>
                            <td>${course.cname}</td>
                            <td>${course.cpno || ''}</td>
                            <td>${course.ccredit}</td>
                            <td>${course.studentCount}</td>
                            <td>${course.avgGrade !== null ? course.avgGrade : 'N/A'}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-icon btn-edit" onclick="showEditCourseModal('${course.cno}')" title="编辑">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                    <button class="btn-icon btn-delete" onclick="deleteCourse('${course.cno}')" title="删除">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                    <button class="btn-icon btn-view" onclick="showCourseStudentsModal('${course.cno}')" title="查看学生">
                                        <i class="bi bi-people-fill"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `);
                });
            });
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error('加载课程数据失败:', textStatus, errorThrown);
            alert('加载课程数据失败，请检查后端服务是否正常运行');
        });
    }

    // 加载选课数据
    function loadSCs() {
        $.get(`${API_BASE_URL}/sc`, function(data) {
            const tbody = $('#scTableBody');
            tbody.empty();
            data.forEach(sc => {
                tbody.append(`
                      <tr class="fade-in">
                            <td>${sc.sno}</td>
                            <td>${sc.cno}</td>
                            <td>${sc.grade}</td>
                            <td>
                              <div class="action-buttons">
                                  <button class="btn-icon btn-edit" onclick="showEditSCModal('${sc.sno}', '${sc.cno}')" title="编辑">
                                      <i class="bi bi-pencil-fill"></i>
                                  </button>
                                  <button class="btn-icon btn-delete" onclick="deleteSC('${sc.sno}', '${sc.cno}')" title="删除">
                                      <i class="bi bi-trash-fill"></i>
                                  </button>
                              </div>
                            </td>
                        </tr>
                    `);
            });
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error('加载选课数据失败:', textStatus, errorThrown);
            alert('加载选课数据失败，请检查后端服务是否正常运行');
        });
    }

    // 显示添加学生模态框
    function showAddStudentModal() {
        $('#addStudentForm')[0].reset();
        new bootstrap.Modal(document.getElementById('addStudentModal')).show();
    }

    // 显示添加课程模态框
    function showAddCourseModal() {
        $('#addCourseForm')[0].reset();
        new bootstrap.Modal(document.getElementById('addCourseModal')).show();
    }

    // 显示添加选课模态框
    function showAddSCModal() {
        $('#addSCForm')[0].reset();
        new bootstrap.Modal(document.getElementById('addSCModal')).show();
    }

    // 添加学生
    function addStudent() {
        const formData = {
            sno: $('#addStudentForm [name="sno"]').val(),
            sname: $('#addStudentForm [name="sname"]').val(),
            sgender: $('#addStudentForm [name="sgender"]').val(),
            sage: parseInt($('#addStudentForm [name="sage"]').val()),
            sdept: $('#addStudentForm [name="sdept"]').val()
        };

        $.ajax({
            url: `${API_BASE_URL}/student`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function() {
                bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                loadStudents();
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert('添加学生失败：' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
            }
        });
    }

    // 显示选课模态框
    function showSelectCourseModal(sno) {
        $('#studentSnoForSelectCourse').val(sno);
        
        $.get(`${API_BASE_URL}/sc/student/${sno}`, function(selectedCourses) {
            const selectedCourseIds = selectedCourses.map(sc => sc.cno);
            
            $.get(`${API_BASE_URL}/course`, function(allCourses) {
                const availableCourses = allCourses.filter(course => {
                    if (selectedCourseIds.includes(course.cno)) {
                        return false;
                    }
                    if (!course.cpno) {
                        return true;
                    }
                    const prerequisiteCourse = selectedCourses.find(sc => sc.cno === course.cpno);
                    return prerequisiteCourse && prerequisiteCourse.grade >= 60;
                });
                
                const tbody = $('#availableCoursesTableBody');
                tbody.empty();
                
                if (availableCourses.length === 0) {
                    tbody.append('<tr><td colspan="5" class="text-center">没有可选课程</td></tr>');
                } else {
                    availableCourses.forEach(course => {
                        tbody.append(`
                              <tr class="fade-in">
                                <td>${course.cno}</td>
                                <td>${course.cname}</td>
                                <td>${course.cpno || '无'}</td>
                                <td>${course.ccredit}</td>
                                <td>
                                      <div class="action-buttons">
                                          <button class="btn-icon btn-select" onclick="selectCourse('${sno}', '${course.cno}')" title="选择">
                                              <i class="bi bi-plus-circle-fill"></i>
                                          </button>
                                      </div>
                                </td>
                            </tr>
                        `);
                    });
                }
                new bootstrap.Modal(document.getElementById('selectCourseModal')).show();
            });
        });
    }
    
    // 选课
    function selectCourse(sno, cno) {
        const formData = {
            sno: sno,
            cno: cno,
            grade: 0
        };
        
        $.ajax({
            url: `${API_BASE_URL}/sc`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function() {
                alert('选课成功！');
                bootstrap.Modal.getInstance(document.getElementById('selectCourseModal')).hide();
                loadSCs();
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert('选课失败：' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
            }
        });
    }
    
    // 显示退课模态框
    function showDropCourseModal(sno) {
        $('#studentSnoForDropCourse').val(sno);
        
        $.get(`${API_BASE_URL}/sc/student/${sno}`, function(selectedCourses) {
            $.get(`${API_BASE_URL}/course`, function(allCourses) {
                const studentCourses = selectedCourses.map(sc => {
                    const courseInfo = allCourses.find(c => c.cno === sc.cno) || {};
                    return {
                        ...sc,
                        cname: courseInfo.cname || '未知课程'
                    };
                });
                
                const tbody = $('#studentCoursesTableBody');
                tbody.empty();
                
                if (studentCourses.length === 0) {
                    tbody.append('<tr><td colspan="4" class="text-center">没有选课记录</td></tr>');
                } else {
                    studentCourses.forEach(course => {
                        tbody.append(`
                              <tr class="fade-in">
                                <td>${course.cno}</td>
                                <td>${course.cname}</td>
                                <td>${course.grade}</td>
                                <td>
                                      <div class="action-buttons">
                                          <button class="btn-icon btn-delete" onclick="dropCourse('${sno}', '${course.cno}')" title="退课">
                                              <i class="bi bi-dash-circle-fill"></i>
                                          </button>
                                      </div>
                                </td>
                            </tr>
                        `);
                    });
                }
                new bootstrap.Modal(document.getElementById('dropCourseModal')).show();
            });
        });
    }
    
    // 退课
    function dropCourse(sno, cno) {
        if (confirm('确定要退选该课程吗？')) {
            $.ajax({
                url: `${API_BASE_URL}/sc/${sno}/${cno}`,
                type: 'DELETE',
                success: function() {
                    const modalElement = document.getElementById('dropCourseModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                    alert('退课成功！');
                    loadSCs();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    alert('退课失败：' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
                }
            });
        }
    }
    
    // 显示编辑学生模态框
    function showEditStudentModal(sno) {
        const student = allStudents.find(student => student.sno === sno);
        if (student) {
            $('#editStudentForm [name="sno"]').val(student.sno);
            $('#editStudentForm [name="sname"]').val(student.sname);
            $('#editStudentForm [name="sgender"]').val(student.sgender);
            $('#editStudentForm [name="sage"]').val(student.sage);
            $('#editStudentForm [name="sdept"]').val(student.sdept);
            
            const modalElement = document.getElementById('editStudentModal');
            if (modalElement) {
                new bootstrap.Modal(modalElement).show();
            }
        } else {
            alert("找不到该学生信息，请刷新页面后重试");
        }
    }
    
    // 更新学生信息
    function updateStudent() {
        const formData = {
            sno: $('#editStudentForm [name="sno"]').val(),
            sname: $('#editStudentForm [name="sname"]').val(),
            sgender: $('#editStudentForm [name="sgender"]').val(),
            sage: parseInt($('#editStudentForm [name="sage"]').val()),
            sdept: $('#editStudentForm [name="sdept"]').val()
        };
        
        $.ajax({
            url: `${API_BASE_URL}/student/${formData.sno}`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function() {
                alert('更新成功！');
                bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
                loadStudents();
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert('更新学生信息失败：' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
            }
        });
    }
    
    // 显示编辑课程模态框
    function showEditCourseModal(cno) {
        $.get(`${API_BASE_URL}/course/${cno}`, function(course) {
            $('#editCourseForm [name="cno"]').val(course.cno);
            $('#editCourseForm [name="cname"]').val(course.cname);
            $('#editCourseForm [name="cpno"]').val(course.cpno || '');
            $('#editCourseForm [name="ccredit"]').val(course.ccredit);
            new bootstrap.Modal(document.getElementById('editCourseModal')).show();
        });
    }
    
    // 更新课程信息
    function updateCourse() {
        const formData = {
            cno: $('#editCourseForm [name="cno"]').val(),
            cname: $('#editCourseForm [name="cname"]').val(),
            cpno: $('#editCourseForm [name="cpno"]').val() || null,
            ccredit: parseInt($('#editCourseForm [name="ccredit"]').val())
        };
        
        $.ajax({
            url: `${API_BASE_URL}/course/${formData.cno}`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function() {
                alert('更新成功！');
                bootstrap.Modal.getInstance(document.getElementById('editCourseModal')).hide();
                loadCourses();
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert('更新课程信息失败：' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
            }
        });
    }
    
    // 显示编辑选课成绩模态框
    function showEditSCModal(sno, cno) {
        $.get(`${API_BASE_URL}/sc/student/${sno}`, function(scList) {
            const sc = scList.find(item => item.cno === cno);
            if (sc) {
                $('#editSCForm [name="sno"]').val(sc.sno);
                $('#editSCForm [name="cno"]').val(sc.cno);
                $('#editSCForm [name="grade"]').val(sc.grade);
                new bootstrap.Modal(document.getElementById('editSCModal')).show();
            } else {
                alert('未找到选课记录');
            }
        });
    }
    
    // 更新选课成绩
    function updateSC() {
        const formData = {
            sno: $('#editSCForm [name="sno"]').val(),
            cno: $('#editSCForm [name="cno"]').val(),
            grade: parseInt($('#editSCForm [name="grade"]').val())
        };
        
        $.ajax({
            url: `${API_BASE_URL}/sc`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function() {
                alert('更新成功！');
                bootstrap.Modal.getInstance(document.getElementById('editSCModal')).hide();
                loadSCs();
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert('更新选课成绩失败：' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
            }
        });
    }

    // 添加课程
    function addCourse() {
        const formData = {
            cno: $('#addCourseForm [name="cno"]').val(),
            cname: $('#addCourseForm [name="cname"]').val(),
            cpno: $('#addCourseForm [name="cpno"]').val() || null,
            ccredit: parseInt($('#addCourseForm [name="ccredit"]').val())
        };

        $.ajax({
            url: `${API_BASE_URL}/course`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function() {
                alert('添加课程成功！');
                bootstrap.Modal.getInstance(document.getElementById('addCourseModal')).hide();
                loadCourses();
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert('添加课程失败：' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
            }
        });
    }
    
    // 添加选课
    function addSC() {
        const formData = {
            sno: $('#addSCForm [name="sno"]').val(),
            cno: $('#addSCForm [name="cno"]').val(),
            grade: parseInt($('#addSCForm [name="grade"]').val())
        };

        $.ajax({
            url: `${API_BASE_URL}/sc`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function() {
                alert('添加选课成功！');
                bootstrap.Modal.getInstance(document.getElementById('addSCModal')).hide();
                loadSCs();
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert('添加选课失败：' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
            }
        });
    }

    // 删除学生
    function deleteStudent(sno) {
        $.get(`${API_BASE_URL}/sc/student/${sno}`, function(data) {
            if (data && data.length > 0) {
                $.get(`${API_BASE_URL}/course`, function(allCourses) {
                    const studentCourses = data.map(sc => {
                        const courseInfo = allCourses.find(c => c.cno === sc.cno) || {};
                        return { ...sc, cname: courseInfo.cname || '未知课程' };
                    });
                    
                    const tbody = $('#studentCoursesToDeleteTableBody');
                    tbody.empty();
                    studentCourses.forEach(course => {
                        tbody.append(`
                              <tr class="fade-in">
                                <td>${course.cno}</td>
                                <td>${course.cname}</td>
                                <td>${course.grade}</td>
                              </tr>`);
                    });
                    $('#studentSnoToDelete').val(sno);
                    new bootstrap.Modal(document.getElementById('deleteStudentConfirmModal')).show();
                });
            } else {
                if(confirm('确定要删除这个学生吗？')) {
                    executeDeleteStudent(sno);
                }
            }
        }).fail(function() {
            if(confirm('确定要删除这个学生吗？')) {
                executeDeleteStudent(sno);
            }
        });
    }
    
    // 执行删除学生操作
    function executeDeleteStudent(sno) {
        if (!sno) sno = $('#studentSnoToDelete').val();
        
        $.ajax({
            url: `${API_BASE_URL}/sc/student/${sno}`,
            type: 'DELETE',
            success: function() {
        $.ajax({
            url: `${API_BASE_URL}/student/${sno}`,
            type: 'DELETE',
            success: function() {
                const modalElement = document.getElementById('deleteStudentConfirmModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) modal.hide();
                loadStudents();
            },
            error: function(jqXHR, textStatus, errorThrown) {
                        alert('删除学生失败：' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
                    }
                });
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert('删除学生选课记录失败：' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
            }
        });
    }

    // 删除课程
    function deleteCourse(cno) {
        $.get(`${API_BASE_URL}/sc/course/${cno}`, function(data) {
            if (data && data.length > 0) {
                $.get(`${API_BASE_URL}/student`, function(allStudents) {
                    const courseStudents = data.map(sc => {
                        const studentInfo = allStudents.find(s => s.sno === sc.sno) || {};
                        return { ...sc, sname: studentInfo.sname || '未知学生' };
                    });

                    const tbody = $('#courseStudentsToDeleteTableBody');
                    tbody.empty();
                    courseStudents.forEach(student => {
                        tbody.append(`
                              <tr class="fade-in">
                                  <td>${student.sno}</td>
                                  <td>${student.sname}</td>
                                  <td>${student.grade}</td>
                              </tr>`);
                    });
                    $('#courseCnoToDelete').val(cno);
                    new bootstrap.Modal(document.getElementById('deleteCourseConfirmModal')).show();
                });
            } else {
                if(confirm('确定要删除这个课程吗？')) {
                    executeDeleteCourse(cno);
                }
            }
        }).fail(function() {
            if(confirm('确定要删除这个课程吗？')) {
                executeDeleteCourse(cno);
            }
        });
    }

    // 执行删除课程操作
    function executeDeleteCourse(cno) {
        if (!cno) cno = $('#courseCnoToDelete').val();

        $.ajax({
            url: `${API_BASE_URL}/sc/course/${cno}`,
            type: 'DELETE',
            success: function() {
            $.ajax({
                url: `${API_BASE_URL}/course/${cno}`,
                type: 'DELETE',
                success: function() {
                        const modalElement = document.getElementById('deleteCourseConfirmModal');
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) modal.hide();
                    loadCourses();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                        alert('删除课程失败：' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
                }
            });
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert('删除课程选课记录失败：' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
        }
        });
    }

    // 删除选课
    function deleteSC(sno, cno) {
        if (confirm('确定要删除这个选课记录吗？')) {
            $.ajax({
                url: `${API_BASE_URL}/sc/${sno}/${cno}`,
                type: 'DELETE',
                success: function() {
                    alert('删除选课记录成功！');
                    loadSCs();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    alert('删除选课记录失败：' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
                }
            });
        }
    }

    // 显示选修课程的学生和成绩
    function showCourseStudentsModal(cno) {
        $.get(`${API_BASE_URL}/sc/course/${cno}`, function(scData) {
            // 获取学生信息
            $.get(`${API_BASE_URL}/student`, function(studentData) {
                const courseStudents = scData.map(sc => {
                    const student = studentData.find(s => s.sno === sc.sno) || {};
                    return {
                        sno: sc.sno,
                        sname: student.sname || '未知学生',
                        grade: sc.grade
                    };
                });
                
                // 按成绩降序排列
                courseStudents.sort((a, b) => b.grade - a.grade);
                
                const tbody = $('#courseStudentsTableBody');
                tbody.empty();
                
                if (courseStudents.length === 0) {
                    tbody.append('<tr><td colspan="3" class="text-center">没有学生选修此课程</td></tr>');
                } else {
                    courseStudents.forEach(student => {
                        tbody.append(`
                            <tr class="fade-in">
                                <td>${student.sno}</td>
                                <td>${student.sname}</td>
                                <td>${student.grade}</td>
                            </tr>
                        `);
                    });
                }
                
                new bootstrap.Modal(document.getElementById('courseStudentsModal')).show();
            });
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error('加载选修课程的学生数据失败:', textStatus, errorThrown);
            alert('加载选修课程的学生数据失败，请检查后端服务是否正常运行');
        });
    }

    // 加载教师数据
    function loadTeachers() {
        $.get(`${API_BASE_URL}/teacher`, function(data) {
            const tbody = $('#teacherTableBody');
            tbody.empty();
            
            if (data.length === 0) {
                tbody.append('<tr><td colspan="3" class="text-center">没有教师数据</td></tr>');
                return;
            }
            
            data.forEach(teacher => {
                tbody.append(`
                    <tr class="fade-in">
                        <td>${teacher.tName}</td>
                        <td>${teacher.tCourse || '未分配'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon btn-view" onclick="showTeacherStudentsModal('${teacher.tName}')" title="查看学生">
                                    <i class="bi bi-people-fill"></i>
                                </button>
                                <button class="btn-icon btn-edit" onclick="showEditTeacherModal('${teacher.tName}')" title="编辑">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                                <button class="btn-icon btn-delete" onclick="deleteTeacher('${teacher.tName}')" title="删除">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `);
            });
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error('加载教师数据失败:', textStatus, errorThrown);
            alert('加载教师数据失败，请检查后端服务是否正常运行');
        });
    }
    
    // 显示添加教师模态框
    function showAddTeacherModal() {
        $('#addTeacherForm')[0].reset();
        
        // 获取所有课程提供选择
        $.get(`${API_BASE_URL}/course`, function(courses) {
            const select = $('#tCourseAdd');
            select.find('option:not(:first)').remove();
            
            courses.forEach(course => {
                select.append(`<option value="${course.cno}">${course.cname}</option>`);
            });
            
            // 确保模态框显示后，先清除以前可能的选择
            $('#tNameAdd').val('');
            $('#tCourseAdd').val('');
            
            new bootstrap.Modal(document.getElementById('addTeacherModal')).show();
        });
    }
    
    // 显示编辑教师模态框
    function showEditTeacherModal(tName) {
        // 获取教师信息
        $.get(`${API_BASE_URL}/teacher/${tName}`, function(teacher) {
            $('#editTeacherForm [name="tName"]').val(teacher.tName);
            
            // 获取所有课程提供选择
            $.get(`${API_BASE_URL}/course`, function(courses) {
                const select = $('#tCourseEdit');
                select.empty();
                select.append('<option value="" disabled>请选择课程</option>');
                
                courses.forEach(course => {
                    const selected = course.cno === teacher.tCourse ? 'selected' : '';
                    select.append(`<option value="${course.cno}" ${selected}>${course.cname}</option>`);
                });
                
                new bootstrap.Modal(document.getElementById('editTeacherModal')).show();
            });
        });
    }
    
    // 删除教师
    function deleteTeacher(tName) {
        if (confirm(`确定要删除教师"${tName}"吗？`)) {
            $.ajax({
                url: `${API_BASE_URL}/teacher/${tName}`,
                type: 'DELETE',
                success: function() {
                    alert('删除教师成功！');
                    loadTeachers();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    alert('删除教师失败：' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
                }
            });
        }
    }
    
    // 添加教师
    function addTeacher() {
        const tNameValue = $('#tNameAdd').val();
        const tCourseValue = $('#tCourseAdd').val();
        
        // 添加表单验证
        if (!tNameValue || tNameValue.trim() === '') {
            alert('请输入教师姓名');
            return;
        }
        
        if (!tCourseValue || tCourseValue === '') {
            alert('请选择讲授课程');
            return;
        }
        
        console.log('tNameAdd value:', tNameValue);
        console.log('tCourseAdd value:', tCourseValue);
        
        // 确保属性名与后端实体类的属性名完全一致
        const formData = JSON.stringify({
            "tName": tNameValue,
            "tCourse": tCourseValue
        });
        
        console.log('发送的JSON数据:', formData);

        $.ajax({
            url: `${API_BASE_URL}/teacher`,
            type: 'POST',
            contentType: 'application/json',
            data: formData,
            success: function() {
                alert('添加教师成功！');
                bootstrap.Modal.getInstance(document.getElementById('addTeacherModal')).hide();
                loadTeachers();
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error('添加教师失败:', jqXHR.responseJSON || errorThrown);
                alert('添加教师失败：' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
            }
        });
    }
    
    // 更新教师信息
    function updateTeacher() {
        const tNameValue = $('#tNameEdit').val();
        const tCourseValue = $('#tCourseEdit').val();
        
        if (!tNameValue || tNameValue.trim() === '') {
            alert('教师姓名不能为空');
            return;
        }
        
        if (!tCourseValue || tCourseValue === '') {
            alert('请选择讲授课程');
            return;
        }
        
        // 确保属性名与后端实体类的属性名完全一致
        const formData = JSON.stringify({
            "tName": tNameValue,
            "tCourse": tCourseValue
        });
        
        console.log('发送的JSON数据:', formData);

        $.ajax({
            url: `${API_BASE_URL}/teacher/${tNameValue}`,
            type: 'PUT',
            contentType: 'application/json',
            data: formData,
            success: function() {
                alert('更新教师信息成功！');
                bootstrap.Modal.getInstance(document.getElementById('editTeacherModal')).hide();
                loadTeachers();
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error('更新教师失败:', jqXHR.responseJSON || errorThrown);
                alert('更新教师信息失败：' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
            }
        });
    }

    // 显示教师的学生和成绩模态框
    function showTeacherStudentsModal(tName) {
        // 获取教师信息和课程
        $.get(`${API_BASE_URL}/teacher/${tName}`, function(teacher) {
            if (!teacher.tCourse) {
                alert('该教师未分配课程');
                return;
            }
            
            $('#modalTeacherName').text(tName);
            $('#modalCourseName').text(teacher.tCourse);
            
            // 获取选修该教师课程的学生和成绩
            $.get(`${API_BASE_URL}/sc/teacher/${tName}`, function(students) {
                const tbody = $('#teacherStudentsTableBody');
                tbody.empty();
                
                if (students.length === 0) {
                    tbody.append('<tr><td colspan="4" class="text-center">没有学生选修此课程</td></tr>');
                } else {
                    students.forEach(student => {
                        tbody.append(`
                            <tr class="fade-in">
                                <td>${student.sno}</td>
                                <td>${student.sname}</td>
                                <td>${student.grade}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="showEditGradeModal('${student.sno}', '${teacher.tCourse}', '${student.sname}', ${student.grade})">
                                        编辑成绩
                                    </button>
                                </td>
                            </tr>
                        `);
                    });
                }
                
                new bootstrap.Modal(document.getElementById('teacherStudentsModal')).show();
            }).fail(function(jqXHR) {
                console.error('获取学生数据失败:', jqXHR);
                alert('获取学生数据失败');
            });
        }).fail(function(jqXHR) {
            console.error('获取教师信息失败:', jqXHR);
            alert('获取教师信息失败');
        });
    }
    
    // 显示编辑成绩模态框
    function showEditGradeModal(sno, cno, sname, grade) {
        // 隐藏当前模态框，显示编辑成绩模态框
        bootstrap.Modal.getInstance(document.getElementById('teacherStudentsModal')).hide();
        
        // 设置表单值
        $('#studentNoGrade').val(sno);
        $('#studentNameGrade').val(sname);
        $('#courseNameGrade').val(cno);
        $('#gradeInput').val(grade);
        $('#snoGrade').val(sno);
        $('#cnoGrade').val(cno);
        
        // 显示编辑成绩模态框
        new bootstrap.Modal(document.getElementById('editGradeModal')).show();
    }
    
    // 更新成绩
    function updateGrade() {
        const sno = $('#snoGrade').val();
        const cno = $('#cnoGrade').val();
        const grade = $('#gradeInput').val();
        
        if (grade < 0 || grade > 100) {
            alert('成绩必须在0-100之间');
            return;
        }
        
        $.ajax({
            url: `${API_BASE_URL}/sc`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({
                "Sno": sno,
                "Cno": cno,
                "Grade": parseInt(grade)
            }),
            success: function() {
                alert('成绩更新成功！');
                bootstrap.Modal.getInstance(document.getElementById('editGradeModal')).hide();
                
                // 刷新教师学生列表
                const teacherName = $('#modalTeacherName').text();
                setTimeout(() => {
                    showTeacherStudentsModal(teacherName);
                }, 300);
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error('更新成绩失败:', jqXHR.responseJSON || errorThrown);
                alert('更新成绩失败：' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
            }
        });
    }
</script>
</body>
</html> 
